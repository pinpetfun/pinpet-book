# üí± Introducci√≥n al Trading Spot de PinPet

## üìä Descripci√≥n General de la Funcionalidad

El trading spot es una de las funcionalidades principales de la plataforma PinPet, permitiendo a los usuarios comprar y vender tokens directamente en pools de liquidez descentralizados. A diferencia del modelo tradicional de libro de √≥rdenes, PinPet utiliza un mecanismo de creador de mercado automatizado (AMM), basado en el algoritmo de producto constante (x √ó y = k) para determinar autom√°ticamente los precios de trading.

**‚ú® Caracter√≠sticas Principales:**
- **‚ö° Ejecuci√≥n Instant√°nea**: No es necesario esperar a que coincidan compradores y vendedores, las transacciones se completan inmediatamente
- **üîç Precios Transparentes**: Los precios son calculados autom√°ticamente por algoritmos, de manera p√∫blica y transparente
- **üåä Liquidez Continua**: Mientras el pool tenga activos suficientes, se puede operar en cualquier momento
- **üõ°Ô∏è Protecci√≥n contra Slippage**: Los usuarios pueden establecer l√≠mites de precio m√°ximo/m√≠nimo para prevenir fluctuaciones de precio anormales

---

## üõí Flujo de Transacci√≥n de Compra (Buy)

### üë§ Pasos de Operaci√≥n del Usuario

La transacci√≥n de compra permite a los usuarios utilizar SOL (el token nativo de Solana) para comprar tokens del proyecto.

```mermaid
flowchart TD
    Start([Usuario inicia solicitud de compra]) --> Input[Ingresar cantidad de compra y l√≠mite de precio]
    Input --> Validate{Validar par√°metros de transacci√≥n}
    Validate -->|Par√°metros inv√°lidos| Error1[Retornar mensaje de error]
    Validate -->|Par√°metros v√°lidos| Calculate[Calcular SOL requerido y comisiones]
    Calculate --> Check{Verificar si activa liquidaci√≥n}
    Check -->|√ìrdenes vencidas| Liquidate[Liquidar autom√°ticamente √≥rdenes vencidas]
    Check -->|No requiere liquidaci√≥n| Transfer1
    Liquidate --> Transfer1[Usuario transfiere SOL al pool]
    Transfer1 --> Transfer2[Pool transfiere tokens al usuario]
    Transfer2 --> Fee[Distribuir comisiones de trading]
    Fee --> Update[Actualizar precio y reservas del pool]
    Update --> Success([Transacci√≥n completada])
```

### üîë Descripci√≥n de Par√°metros Clave

| Nombre del Par√°metro | Descripci√≥n | Valor de Ejemplo | Notas |
|---------|---------|--------|------|
| buy_token_amount | Cantidad de tokens que desea comprar | 1000000 (1 token) | Valor m√≠nimo: 1000000 (1 token) |
| max_sol_amount | Cantidad m√°xima de SOL dispuesto a pagar | 50000000 (0.05 SOL) | Utilizado para prevenir slippage excesivo |
| lp_pairs | Snapshot del estado del pool de liquidez | [{sol: 30, token: 1000000}] | Proporcionado autom√°ticamente por el frontend |

### ‚öôÔ∏è L√≥gica de Ejecuci√≥n de Transacci√≥n

1. **Validaci√≥n de Par√°metros**
   - Verificar si la cantidad de compra alcanza el volumen m√≠nimo de trading (1 token)
   - Validar que el estado del pool de liquidez coincida con el on-chain

2. **C√°lculo de Precio**
   - Basado en las reservas actuales del pool, usar la f√≥rmula de producto constante para calcular el SOL requerido
   - Calcular el monto real a pagar incluyendo comisiones
   - Verificar si el precio de ejecuci√≥n real excede el valor m√°ximo establecido por el usuario

3. **Mecanismo de Liquidaci√≥n Autom√°tica**
   - Si la transacci√≥n causar√≠a que el precio cruce el precio de liquidaci√≥n de algunas √≥rdenes apalancadas, el sistema liquida autom√°ticamente esas √≥rdenes
   - Las comisiones generadas por la liquidaci√≥n se distribuyen entre la plataforma y los partners

4. **Transferencia de Fondos**
   - Cuenta del usuario ‚Üí Pool de liquidez: Transferir SOL (incluidas comisiones)
   - Pool de liquidez ‚Üí Cuenta del usuario: Transferir tokens

5. **Distribuci√≥n de Comisiones**
   - Distribuir seg√∫n proporciones preestablecidas entre partners y proveedores t√©cnicos
   - La tasa de comisi√≥n predeterminada puede ser configurada por el administrador

6. **Actualizaci√≥n de Estado**
   - Actualizar el precio actual del pool de liquidez
   - Recalcular las reservas de SOL y tokens del pool
   - Verificar si se activa descuento en comisiones

---

## üí∏ Flujo de Transacci√≥n de Venta (Sell)

### üë§ Pasos de Operaci√≥n del Usuario

La transacci√≥n de venta permite a los usuarios vender los tokens que poseen a cambio de SOL.

```mermaid
flowchart TD
    Start([Usuario inicia solicitud de venta]) --> Input[Ingresar cantidad de venta y l√≠mite de precio]
    Input --> Validate{Validar par√°metros de transacci√≥n}
    Validate -->|Par√°metros inv√°lidos| Error1[Retornar mensaje de error]
    Validate -->|Par√°metros v√°lidos| Calculate[Calcular SOL a recibir y comisiones]
    Calculate --> Check{Verificar si activa liquidaci√≥n}
    Check -->|√ìrdenes vencidas| Liquidate[Liquidar autom√°ticamente √≥rdenes vencidas]
    Check -->|No requiere liquidaci√≥n| Transfer1
    Liquidate --> Transfer1[Usuario transfiere tokens al pool]
    Transfer1 --> Transfer2[Pool transfiere SOL al usuario]
    Transfer2 --> Fee[Deducir y distribuir comisiones]
    Fee --> Update[Actualizar precio y reservas del pool]
    Update --> Success([Transacci√≥n completada])
```

### üîë Descripci√≥n de Par√°metros Clave

| Nombre del Par√°metro | Descripci√≥n | Valor de Ejemplo | Notas |
|---------|---------|--------|------|
| sell_token_amount | Cantidad de tokens que desea vender | 1000000 (1 token) | Valor m√≠nimo: 1000000 (1 token) |
| min_sol_output | Cantidad m√≠nima de SOL esperada a recibir | 20000000 (0.02 SOL) | Utilizado para prevenir slippage excesivo |
| lp_pairs | Snapshot del estado del pool de liquidez | [{sol: 30, token: 1000000}] | Proporcionado autom√°ticamente por el frontend |

### ‚öôÔ∏è L√≥gica de Ejecuci√≥n de Transacci√≥n

1. **Validaci√≥n de Par√°metros**
   - Verificar si la cantidad de venta alcanza el volumen m√≠nimo de trading (1 token)
   - Validar que el saldo de la cuenta de tokens del usuario sea suficiente
   - Confirmar que el estado del pool de liquidez sea v√°lido

2. **C√°lculo de Precio**
   - Basado en las reservas actuales del pool, usar la f√≥rmula de producto constante para calcular el SOL a recibir
   - Calcular el monto real acreditado despu√©s de deducir comisiones
   - Verificar si el precio de ejecuci√≥n real est√° por debajo del valor m√≠nimo establecido por el usuario

3. **Mecanismo de Liquidaci√≥n Autom√°tica**
   - Si la transacci√≥n causar√≠a que el precio cruce el precio de liquidaci√≥n de algunas √≥rdenes apalancadas, el sistema liquida autom√°ticamente esas √≥rdenes
   - Distribuci√≥n de comisiones de liquidaci√≥n y recompensas

4. **Transferencia de Fondos**
   - Cuenta del usuario ‚Üí Pool de liquidez: Transferir tokens
   - Pool de liquidez ‚Üí Cuenta del usuario: Transferir SOL (con comisiones deducidas)

5. **Procesamiento de Comisiones**
   - Deducir comisiones del SOL a recibir
   - Distribuir seg√∫n proporciones entre partners y proveedores t√©cnicos

6. **Actualizaci√≥n de Estado**
   - Actualizar el precio actual del pool de liquidez (precio disminuye)
   - Recalcular las reservas de SOL y tokens del pool
   - Verificar si se activa descuento en comisiones

---

## üí° Ejemplos de Casos de Uso

### üìà Escenario Uno: Transacci√≥n de Compra Normal

**Contexto:**
- Precio actual: 1 token = 0.03 SOL
- El usuario desea comprar 10 tokens
- Tasa de comisi√≥n: 1%

**Flujo de Operaci√≥n:**
1. Usuario establece cantidad de compra: 10,000,000 (10 tokens)
2. Usuario establece pago m√°ximo: 0.35 SOL (350,000,000)
3. Sistema calcula necesidad real: 0.303 SOL (incluidas comisiones)
4. Verificaci√≥n de precio aprobada (no excede el l√≠mite m√°ximo)
5. Ejecuci√≥n de transacci√≥n:
   - Usuario paga 0.303 SOL
   - Recibe 10 tokens
   - Comisi√≥n de 0.003 SOL distribuida a la plataforma
6. Precio post-ejecuci√≥n sube a: 0.0303 SOL/token

---

### üìâ Escenario Dos: Venta que Activa Liquidaci√≥n Autom√°tica

**Contexto:**
- Precio actual: 1 token = 0.05 SOL
- Existe una orden long con precio de liquidaci√≥n de 0.048 SOL
- El usuario desea vender 50 tokens

**Flujo de Operaci√≥n:**
1. Usuario establece cantidad de venta: 50,000,000 (50 tokens)
2. Usuario establece ingreso m√≠nimo: 2.3 SOL
3. Sistema detecta que la venta har√≠a caer el precio por debajo de 0.048 SOL
4. Sistema liquida autom√°ticamente la orden long:
   - Calcular ganancias/p√©rdidas de la orden
   - Cobrar comisi√≥n de liquidaci√≥n
   - Cerrar cuenta de orden, devolver alquiler
5. Continuar con la ejecuci√≥n de la venta:
   - Usuario transfiere 50 tokens
   - Recibe 2.4 SOL (despu√©s de deducir comisiones)
6. Precio post-ejecuci√≥n cae a: 0.047 SOL/token

---

### üõ°Ô∏è Escenario Tres: Activaci√≥n de Protecci√≥n contra Slippage

**Contexto:**
- Precio actual: 1 token = 0.02 SOL
- El usuario desea comprar 1000 tokens
- Pool de liquidez peque√±o, transacciones grandes causar√≠an slippage significativo

**Flujo de Operaci√≥n:**
1. Usuario establece cantidad de compra: 1,000,000,000 (1000 tokens)
2. Usuario establece pago m√°ximo: 21 SOL
3. Sistema calcula necesidad real: 22.5 SOL (incluidas comisiones)
4. Verificaci√≥n de precio falla (excede el l√≠mite m√°ximo del usuario)
5. Transacci√≥n rechazada, retorna mensaje de error
6. El usuario puede elegir:
   - Aumentar el l√≠mite de pago m√°ximo
   - Reducir la cantidad de compra
   - Comprar en lotes

---

## ‚ö†Ô∏è Precauciones y Limitaciones

### üö´ Restricciones de Trading

| Elemento Restringido | Requisito Espec√≠fico | Explicaci√≥n |
|---------|---------|---------|
| Volumen m√≠nimo de trading | 1,000,000 (1 token) | Prevenir que transacciones demasiado peque√±as afecten la eficiencia del sistema |
| L√≠mite superior de tasa de comisi√≥n | 10% | Proteger a los usuarios de comisiones excesivas |
| Verificaci√≥n de liquidez | Debe proporcionar snapshot del estado actual del pool | Asegurar consistencia entre estado on-chain y off-chain |
| Protecci√≥n contra slippage | Obligatorio max_sol_amount / min_sol_output | Prevenir p√©rdidas causadas por fluctuaciones de precio anormales |

### ‚ö†Ô∏è Advertencias de Riesgo

1. **üìä Riesgo de Volatilidad de Precios**
   - Transacciones grandes causar√°n slippage significativo
   - Se recomienda realizar transacciones grandes en lotes para reducir costos de impacto
   - Establecer tolerancia razonable al slippage

2. **üí∞ Costos de Comisiones**
   - Cada transacci√≥n generar√° comisiones
   - Transacciones peque√±as frecuentes acumular√°n costos altos de comisiones
   - Se recomienda consolidar transacciones para reducir costos

3. **üíß Riesgo de Liquidez**
   - Cuando la liquidez es insuficiente, las transacciones grandes pueden no completarse
   - Las reservas del pool afectar√°n el precio de ejecuci√≥n
   - Prestar atenci√≥n a las reservas de SOL y tokens del pool

4. **üîÑ Impacto de Liquidaci√≥n Autom√°tica**
   - Las transacciones pueden activar liquidaci√≥n autom√°tica de √≥rdenes apalancadas
   - La liquidaci√≥n consumir√° parte de la liquidez
   - Puede afectar el precio de ejecuci√≥n final


### üîß Requisitos T√©cnicos

**üëõ Requisitos del Usuario:**
- Poseer una billetera Solana (como Phantom, Solflare)
- Tener suficiente SOL en la cuenta para trading y pago de tarifas de transacci√≥n
- Debe crear cuenta de tokens correspondiente antes de operar tokens (generalmente manejado autom√°ticamente por el frontend)

**üíµ Composici√≥n de Tarifas de Transacci√≥n:**
- Tarifas de red Solana: aproximadamente 0.000005 SOL (tarifa de firma de transacci√≥n)
- Comisi√≥n de trading: cobrada como porcentaje del monto de transacci√≥n (configurada por el administrador)
- Alquiler de cuenta: pago √∫nico si se necesita crear nueva cuenta (recuperable)

### ‚ùì Preguntas Frecuentes

**P: ¬øSe pierden comisiones si la transacci√≥n falla?**
R: ‚úÖ No. Si la transacci√≥n es rechazada debido a falla en la verificaci√≥n de par√°metros, no se deducir√° ninguna comisi√≥n, solo se consumir√° una peque√±a tarifa de red Solana (aproximadamente 0.000005 SOL).

**P: ¬øC√≥mo obtener el mejor precio de ejecuci√≥n?**
R: üí° Operar en per√≠odos de liquidez suficiente, evitar vol√∫menes de transacci√≥n excesivos en una sola operaci√≥n, prestar atenci√≥n a la proporci√≥n SOL/Token del pool, elegir el momento adecuado para operar.

**P: ¬øLa liquidaci√≥n autom√°tica afectar√° mi transacci√≥n?**
R: ‚ö†Ô∏è Posiblemente. Si su transacci√≥n activa la liquidaci√≥n de √≥rdenes apalancadas de otros, consumir√° parte de la liquidez, lo que puede causar que el precio de ejecuci√≥n real difiera ligeramente del esperado, pero a√∫n dentro del rango de slippage que estableci√≥.

**P: ¬øRazones comunes para el rechazo de transacciones?**
R: ‚ùå Las razones comunes incluyen:
- Cantidad de compra o venta por debajo del volumen m√≠nimo de trading (1 token)
- Precio de ejecuci√≥n real excede el rango de protecci√≥n contra slippage establecido
- Saldo de cuenta insuficiente (SOL o tokens)
- Snapshot del estado del pool de liquidez expirado (el frontend necesita obtener nuevamente)

**P: ¬øC√≥mo se calculan y distribuyen las comisiones?**
R: üí∞ Las comisiones se cobran como un porcentaje del monto de transacci√≥n (predeterminado 1%, ajustable por el administrador), despu√©s del cobro se distribuyen seg√∫n proporciones preestablecidas entre partners y proveedores t√©cnicos. En algunos casos puede haber descuentos en comisiones.

---

## üîó Funcionalidades Relacionadas

- **üìä Trading Apalancado**: Utilizar mecanismo de pr√©stamo para trading long/short
- **üíß Gesti√≥n de Liquidez**: Ver y gestionar estado de pools de liquidez
- **ü™ô Creaci√≥n de Tokens**: Crear nuevos pares de trading de tokens
- **üìã Gesti√≥n de √ìrdenes**: Ver y gestionar √≥rdenes de trading apalancado

---

*üìù Nota: Este documento es una descripci√≥n de funcionalidad del producto, no incluye detalles de implementaci√≥n t√©cnica. Para informaci√≥n relacionada con desarrollo, consulte la documentaci√≥n t√©cnica del proyecto.*
