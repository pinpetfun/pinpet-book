# 用户订单查询功能说明 User Orders Query Function

## 功能概述 Function Overview

`user_orders` 方法用于查询指定用户在特定代币上的所有订单记录，支持分页和排序功能。

## 使用方法 Usage

### 基本用法 Basic Usage

```javascript
const SpinSDK = require('spin-sdk');

// 初始化SDK Initialize SDK
const sdk = new SpinSDK({
  rpcUrl: 'https://api.mainnet-beta.solana.com',
  spinFastApiUrl: 'http://192.168.18.36:8080' // 你的API服务器地址
});

// 查询用户订单 Query user orders
const userOrders = await sdk.fast.user_orders(
  '8iGFeUkRpyRx8w5uoUMbfZepUr6BfTdPuJmqGoNBntdb', // 用户地址
  '4Kq51Kt48FCwdo5CeKjRVPodH1ticHa7mZ5n5gqMEy1X', // 代币地址
  {
    page: 1,           // 页码，默认1
    limit: 200,        // 每页数量，默认200
    order_by: 'start_time_desc' // 排序方式，默认按开始时间降序
  }
);
```

### 参数说明 Parameters

| 参数名 Parameter | 类型 Type | 必填 Required | 说明 Description |
|-----------------|-----------|---------------|------------------|
| user | string | 是 | 用户钱包地址 User wallet address |
| mint | string | 是 | 代币地址 Token mint address |
| options.page | number | 否 | 页码，默认1 Page number, default 1 |
| options.limit | number | 否 | 每页数量，默认200 Items per page, default 200 |
| options.order_by | string | 否 | 排序方式，默认'start_time_desc' Sort order, default 'start_time_desc' |

### 返回数据格式 Response Format

```javascript
{
  "success": true,
  "data": {
    "orders": [
      {
        "order_type": 2,                    // 订单类型：1=做多Long, 2=做空Short
        "mint": "4Kq51Kt...",              // 代币地址
        "user": "8iGFeUk...",              // 用户地址
        "lock_lp_start_price": "753522984132656210522", // 锁定LP开始价格
        "lock_lp_end_price": "833102733432007194898",   // 锁定LP结束价格
        "lock_lp_sol_amount": 2535405978,   // 锁定LP中SOL数量
        "lock_lp_token_amount": 32000000000000, // 锁定LP中代币数量
        "start_time": 1755964862,           // 开始时间戳
        "end_time": 1756137662,             // 结束时间戳
        "margin_sol_amount": 1909140052,    // 保证金SOL数量
        "borrow_amount": 32000000000000,    // 借贷数量
        "position_asset_amount": 656690798, // 持仓资产数量
        "borrow_fee": 1200,                 // 借贷费率
        "order_pda": "59yP5tpDP6DBcyy4mge9wKKKdLmk45Th4sbd6Un9LxVN" // 订单PDA地址
      }
    ],
    "total": 11,                          // 总订单数
    "user": "8iGFeUk...",                 // 查询的用户地址
    "mint_account": "4Kq51Kt...",         // 查询的代币地址
    "page": 1,                            // 当前页码
    "limit": 200,                         // 每页数量
    "has_next": false,                    // 是否有下一页
    "has_prev": false                     // 是否有上一页
  },
  "message": "Operation successful"
}
```

## 完整示例 Complete Example

```javascript
const SpinSDK = require('spin-sdk');

async function getUserOrdersExample() {
  try {
    // 初始化SDK
    const sdk = new SpinSDK({
      rpcUrl: 'https://api.mainnet-beta.solana.com',
      spinFastApiUrl: 'http://192.168.18.36:8080'
    });
    
    const userAddress = '8iGFeUkRpyRx8w5uoUMbfZepUr6BfTdPuJmqGoNBntdb';
    const mintAddress = '4Kq51Kt48FCwdo5CeKjRVPodH1ticHa7mZ5n5gqMEy1X';
    
    // 获取用户订单
    const result = await sdk.fast.user_orders(userAddress, mintAddress, {
      page: 1,
      limit: 10,
      order_by: 'start_time_desc'
    });
    
    console.log('获取成功 Success:', result.success);
    console.log('订单总数 Total orders:', result.data.total);
    console.log('当前页订单数 Current page orders:', result.data.orders.length);
    
    // 遍历订单
    result.data.orders.forEach((order, index) => {
      console.log(`\n订单 Order ${index + 1}:`);
      console.log(`  类型 Type: ${order.order_type === 1 ? '做多 Long' : '做空 Short'}`);
      console.log(`  PDA: ${order.order_pda}`);
      console.log(`  开始时间 Start: ${new Date(order.start_time * 1000).toLocaleString()}`);
      console.log(`  结束时间 End: ${new Date(order.end_time * 1000).toLocaleString()}`);
      console.log(`  保证金 Margin: ${order.margin_sol_amount} lamports`);
    });
    
    // 如果有多页，获取下一页
    if (result.data.has_next) {
      console.log('\n获取下一页 Getting next page...');
      const nextPage = await sdk.fast.user_orders(userAddress, mintAddress, {
        page: 2,
        limit: 10
      });
      console.log('下一页订单数 Next page orders:', nextPage.data.orders.length);
    }
    
  } catch (error) {
    console.error('查询失败 Query failed:', error.message);
  }
}

// 运行示例
getUserOrdersExample();
```

## 错误处理 Error Handling

```javascript
try {
  const orders = await sdk.fast.user_orders(user, mint);
} catch (error) {
  if (error.message.includes('API请求失败')) {
    console.log('API服务器错误 API server error:', error.message);
  } else if (error.message.includes('网络请求失败')) {
    console.log('网络连接错误 Network connection error');
  } else {
    console.log('其他错误 Other error:', error.message);
  }
}
```

## 注意事项 Notes

1. **API服务器配置 API Server Configuration**: 确保 `spinFastApiUrl` 正确配置为你的API服务器地址
2. **地址格式 Address Format**: 用户地址和代币地址必须是有效的Solana地址格式
3. **分页限制 Pagination Limits**: 建议每页数量不要超过500，避免请求超时
4. **时间格式 Time Format**: 返回的时间戳是Unix时间戳，需要乘以1000转换为JavaScript Date对象
5. **排序选项 Sort Options**: 目前支持按开始时间排序，可选 'start_time_asc' 或 'start_time_desc'

## 测试运行 Test Run

运行测试文件：
```bash
node tests/example-user-orders.js
```